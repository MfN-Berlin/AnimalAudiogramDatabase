Instructions for installing a clone of the database.

# Prerequisites
* Latest Docker engine and Docker Compose (https://docs.docker.com/compose/install/)

# Installation
Clone the repository and all its submodules:

`git clone --recursive git@github.com:MfN-Berlin/AnimalAudiogramDatabase.git`

## Settings
Copy the file `env.tpl` to `.env` (mind the dot at the beginning) and set passwords or alternatively obtain a configuration file.

Copy the `.env` file to the Admin/src directory

`cp .env Admin/src/`

Copy the `.env` file to the API/src/API directory

`cp .env API/src/API`

## Start containers
Then start the application with docker-compose:

`docker-compose up -d`

The first time this command is executed, it will pull the necessary Docker images from Docker Hub. The corresponding Dockerfiles can be found in the submodules pulled when cloning the main repository.

Six containers will be started:

**aad_frontend**

> A Drupal installation providing the Web interface. After configuration, available at `http://localhost`

**aad_api**

> A JSON interface to the audiograms, primarily used by the frontend, but can also be queried as a REST API. See [API documentation](https://animalaudiograms.museumfuernaturkunde.berlin/apidoc).

**aad_db**

> A database server.

**aad_redis**

> A thread broker for the audiogram plotting threads.

**aad_goa**

> Log analysis service.

**aad_admin**

> Audiogram administration backend.

Please do `docker ps` to verify that the required containers have started.

# Database configuration
Obtain a SQL dump of the audiogram data, e.g. from a backup. Copy the dump to the database container

`docker cp dump_audiogrambase.sql aad_db:/tmp/`

Enter the database container

`docker exec -ti aad_db /bin/bash`

Login to the database as the root user and create the `audiogrambase` database. Exit the mysql command line client and import the SQL dump into the new database

`mysql -uroot -p audiogrambase < /tmp/dump_audiogrambase.sql`

## Verify database configuration
Now that the database has data, verify that the API can read the data by calling `http://localhost:9082/api/v1/browse` in a browser (alternatively http://127.0.0.1/api/v1/browse). This should return a JSON response with a listing of audiograms.

Troubleshooting: if you get a server error, make sure that the settings are correct, see "Settings" section above. Also make sure that the .env file has been copied to the required folders.

# API configuration

The audiogram visualizations are generated by the API. The visualization script needs a chache. Create the cache folder by going into the container `docker exec -ti aad_api /bin/bash` and do: `mkdir /src/API/static`.

# Frontend Configuration

## Create frontend database
Obtain a SQL dump of the AAD frontend database, e.g. from a backup. Copy the dump to the database container

`docker cp dump_frontend.sql aad_db:/tmp/`

Enter the database container

`docker exec -ti aad_db /bin/bash`

Login to the database as the root user and create the `frontend` database. Exit the mysql command line client and import the SQL dump into the new database

`mysql -uroot -p frontend < /tmp/dump_frontend.sql`

Obtain a copy of the html Folder and copy it to `mount/html`. If you already have already called docker-compose, you might need to delete the `mount/html` directory created by docker-compose and replace it.

## Connect to the API
Check that the API adress stored in the controller `mount/html/modules/custom//audiogrambase/src/Controller/AudiogrambaseController.php` corresponds to the address you will be using for the site. So for example, if you are testing on localhost, the URL should be

`const API_URL = 'http://localhost:9082/api/v1/browse';`.

Please note that you might need to empty the Drupal cache before changes take effect.

## Drupal configuration
Check the file  
`mount/html/sites/default/settings.php`. At the bottom of the file, it should list the correct username and passowrd for the database.

## Verifying frontend configuration
Restart docker compose, `docker-compose down` followed by `docker-compose up -d`.
Make sure all containers have started. Open `http://localhost`in a browser. You should be able to see the start page of the animal audiograms website. 

Once the website is running, click on te "Browse" tab. This shoul list the audiograms in the database.

# Network
If you are running only this application on your machine, then the provided network configuration will work as-is.

However, if you are running several services on a single machine, you will need to:
* Check in `docker-compose.yml` that all ports are free, otherwise edit them
* Use a reverse proxy, e.g.Pound, to map the external URLs to the internal ports. A sample Pound configuration is provided in `resources/network`.

After changing the network settings, verify that the variable API_URL in  `mount/html/modules/custom//audiogrambase/src/Controller/AudiogrambaseController.php`
points to the correct address.

# Verifying
Test if the installation was successfull:
* http://localhost should show the frontend
* http://localhost:9082/ should show the message 'Audiogrambase API'
* http://localhost/audiogram?ids=253 should show the audiogram of a beluga whale
* http://localhost:9083/admin/v1/start should show the administration backend

# Further configuration
* You will need to setup a backup script. You should backup at least the `audiogrambase` and `frontend` databases.
* You can change the database password. The password has to be changed in mysql, .env files (all 3 of them, see above), and in the `mount/html/sites/default/settings.php`.
* You can change the Drupal administrative password. This has to be changed in Drupal and in the .env files.
* Verify that the log analysis is running. The log report is in http://localhost/report.html

## Troubleshooting

Contact: audiograms@mfn.berlin

Drupal migration howto:
https://websitemigrationguides.com/guide.php?migrate=6


